{{> Site/Header}}

	{{#logged_in}}

		<script type="text/javascript">
			
			var monthNames = ["January", "February", "March", "April", "May", "June",
    			"July", "August", "September", "October", "November", "December"];

			function getData()
			{
				$.getJSON("/api/weights", function(json) {
					drawChart(json);
				});
			}

			function generateTooltip(parsedDate, weightNum, comment, units)
			{
				var hrs = parsedDate.getHours();
				var mins = parsedDate.getMinutes();
				if (mins < 10) mins = "0" + mins;

				var hrSuffix  = (hrs > 12) ? "pm" : "am"; 
				var convHours = (hrs > 12) ? hrs - 12 : hrs;
				if (convHours == 0) convHours = 12;

				var s = "<div style='font-weight: bold; padding: 5px;'>"
					+ monthNames[parsedDate.getMonth()] + " " + parsedDate.getDate()
					+ ", " + parsedDate.getFullYear() + ", " + convHours + ":"
					+ mins + " " + hrSuffix + "<br />Weight: " + weightNum + " " + units;

				if (comment != "")
				{
					s = s + "<br />" + comment;
				}

				s = s + "</div>";

				return s;
			}

			google.load("visualization", "1", { packages:["corechart"] });
			google.setOnLoadCallback(getData);

			function drawChart(jsonData) {

				var data = new google.visualization.DataTable();
				data.addColumn('datetime',   'Year');
				data.addColumn('number',     'Weight');
				data.addColumn({type: 'string', role: 'tooltip', 'p': {'html': true}});

				var minWeightValue = false;
				var maxWeightValue = false;

				for (var i in jsonData)
				{
					var tmp = jsonData[i];

					var dateNum    = parseInt(tmp['date']) * 1000;
					var parsedDate = new Date(dateNum);
					var weightNum  = parseFloat(tmp['weight']);
					var comment    = tmp['comment'];

					var commentVal = generateTooltip(parsedDate, weightNum, comment, 'lbs');

					if (!minWeightValue)
					{
						minWeightValue = weightNum;
					}

					if (!maxWeightValue)
					{
						maxWeightValue = weightNum;
					}

					if (weightNum > maxWeightValue)
					{
						maxWeightValue = weightNum;
					}

					if (weightNum < minWeightValue)
					{
						minWeightValue = weightNum;
					}

					data.addRow([
						parsedDate,
						weightNum,
						commentVal
					]);
				}

				var options = {
					title:     "My Weight",
					pointSize: 4,
					tooltip:   {isHtml: true},
					// vAxis:     {minValue: minWeightValue - 1, maxValue: maxWeightValue + 1},
					// curveType: "function"
				};

				var chart_div = document.getElementById('chart_div');
				var chart = new google.visualization.LineChart(chart_div);
				chart.draw(data, options);
			}
		</script>

		<div id="chart_div" style="width: 1200px; height: 500px;"></div>

		<form method="post" action="/action/weight/add">

			<table>

				<tr>
				<td><label for="weight">Weight:</label></td>
				<td><input type="text" id="weight" name="weight" value="" /></td>
				</tr>

				<tr>
				<td><label for="date">Optional date:</label></td>
				<td><input type="text" id="date" name="date" value="" /></td>
				</tr>

				<tr>
				<td><label for="comment">Comment:</label></td>
				<td><textarea cols="50" rows="4" id="comment" name="comment"></textarea></td>
				</tr>

				<tr>
				<td colspan="2"><input type="submit" value="Submit" /></td>
				</tr>

			</table>

</form>



	{{/logged_in}}
	{{^logged_in}}
		Welcome stranger, doesn't look like you're logged in right now...
	{{/logged_in}}

{{> Site/Footer}}